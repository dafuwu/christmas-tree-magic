<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Merry Christmas Magic - Final</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://fastly.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://fastly.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://fastly.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
        }
    }
    </script>
    <style>
        body { margin: 0; background: #000; color: #d4af37; font-family: sans-serif; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s; }
        .spinner { width: 40px; height: 40px; border: 3px solid #222; border-top: 3px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; text-align: center; }
        h1 { margin-top: 5vh; font-size: 3rem; background: linear-gradient(#fff, #d4af37); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .controls { position: absolute; bottom: 30px; left: 0; right: 0; pointer-events: auto; }
        .btn { border: 1px solid #d4af37; padding: 10px 20px; background: rgba(0,0,0,0.6); color: #d4af37; cursor: pointer; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p>IGNITING MAGIC...</p></div>
    <div id="ui">
        <h1>Merry Christmas</h1>
        <div class="controls">
            <label class="btn">ADD PHOTO<input type="file" id="imgInp" hidden accept="image/*"></label>
            <p style="font-size:12px; opacity:0.6; margin-top:10px;">Drag to Rotate | Hand Gestures loading in background...</p>
        </div>
    </div>
    <video id="webcam" style="display:none" autoplay playsinline></video>
    <div id="container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // --- 初始化 3D 场景 (立即执行) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 50);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('container').appendChild(renderer.domElement);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.4, 0.8));

        const mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // 生成金色树粒子
        const items = [];
        for(let i=0; i<1500; i++) {
            const t = i / 1500;
            const r = 15 * (1-t);
            const angle = t * 50;
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshStandardMaterial({color: 0xd4af37, metalness:0.8}));
            mesh.position.set(Math.cos(angle)*r, t*35-15, Math.sin(angle)*r);
            mainGroup.add(mesh);
            items.push({mesh, orig: mesh.position.clone()});
        }
        scene.add(new THREE.AmbientLight(0xffffff, 1));

        let handLandmarker;
        let mode = 'TREE';

        // --- 异步加载 AI (不影响显示) ---
        async function loadAI() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://fastly.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: `https://fastly.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm/hand_landmarker.task`, delegate: "GPU" },
                    runningMode: "VIDEO"
                });
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('webcam').srcObject = stream;
                console.log("AI Ready");
            } catch (e) { console.log("AI Fallback to mouse"); }
        }

        function animate() {
            requestAnimationFrame(animate);
            mainGroup.rotation.y += 0.005;
            
            if (handLandmarker && document.getElementById('webcam').readyState >= 2) {
                const results = handLandmarker.detectForVideo(document.getElementById('webcam'), performance.now());
                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    mode = dist < 0.05 ? 'SCATTER' : 'TREE';
                }
            }

            items.forEach(item => {
                const target = mode === 'TREE' ? item.orig : new THREE.Vector3().randomDirection().multiplyScalar(30);
                item.mesh.position.lerp(target, 0.05);
            });

            composer.render();
        }

        // 启动逻辑
        loadAI();
        animate();
        // 关键改动：强制移除加载层
        setTimeout(() => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').remove(), 1000);
        }, 800);

        // 照片上传功能
        document.getElementById('imgInp').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                new THREE.TextureLoader().load(ev.target.result, (tex) => {
                    const plane = new THREE.Mesh(new THREE.PlaneGeometry(10,10), new THREE.MeshBasicMaterial({map: tex, side: THREE.DoubleSide}));
                    plane.position.y = 5;
                    mainGroup.add(plane);
                });
            };
            reader.readAsDataURL(file);
        };
    </script>
</body>
</html>
