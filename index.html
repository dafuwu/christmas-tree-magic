<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merry Christmas Magic - Complete Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <script type="importmap">
    {
        "imports": {
            "three": "https://fastly.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://fastly.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://fastly.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
        }
    }
    </script>
    <style>
        :root { --gold: #d4af37; }
        body { margin: 0; background: #000; color: var(--gold); font-family: 'Cinzel', serif; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 2px solid #222; border-top: 2px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #ui-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        h1 { position: absolute; top: 5%; width: 100%; text-align: center; font-size: clamp(24px, 8vw, 56px); background: linear-gradient(#fff, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(212,175,55,0.4)); margin: 0; }
        .controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); pointer-events: auto; text-align: center; }
        .btn-upload { border: 1px solid var(--gold); padding: 12px 25px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); color: var(--gold); cursor: pointer; letter-spacing: 2px; }
        .hint { margin-top: 10px; font-size: 12px; opacity: 0.7; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p>IGNITING HOLIDAY SPIRIT...</p></div>
    <div id="ui-overlay">
        <h1>Merry Christmas</h1>
        <div class="controls">
            <label class="btn-upload">ADD MEMORIES<input type="file" id="imgInp" hidden accept="image/*"></label>
            <div class="hint">Use Hand Gestures: Fist | Open | Pinch</div>
        </div>
    </div>
    <video id="webcam" style="display:none" autoplay playsinline></video>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        const STATE = { mode: 'TREE', rotation: { x: 0, y: 0 }, focusIdx: -1 };
        let handLandmarker;

        // --- 1. 核心视觉系统 ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 200);
        camera.position.set(0, 2, 50);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 2.0;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 找回华丽的辉光
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.6, 0.4, 0.85);
        composer.addPass(bloom);

        const mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // --- 2. 粒子圣诞树生成 ---
        const items = [];
        const boxGeo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const goldMat = new THREE.MeshStandardMaterial({ color: 0xd4af37, metalness: 0.9, roughness: 0.1 });
        const greenMat = new THREE.MeshStandardMaterial({ color: 0x0f4215, roughness: 0.8 });

        for(let i=0; i<2000; i++) {
            const mesh = new THREE.Mesh(i % 5 === 0 ? boxGeo : new THREE.SphereGeometry(0.2), i % 3 === 0 ? goldMat : greenMat);
            const t = i / 2000;
            const r = 15 * (1 - t);
            const angle = t * 60;
            const treePos = new THREE.Vector3(Math.cos(angle)*r, t*40-20, Math.sin(angle)*r);
            const scatterPos = new THREE.Vector3().randomDirection().multiplyScalar(20 + Math.random()*10);
            mesh.position.copy(treePos);
            mainGroup.add(mesh);
            items.push({ mesh, treePos, scatterPos, type: 'DECOR' });
        }

        // --- 3. 找回照片功能 ---
        window.addPhoto = (texture) => {
            const group = new THREE.Group();
            const photo = new THREE.Mesh(new THREE.PlaneGeometry(8, 8), new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
            const frame = new THREE.Mesh(new THREE.PlaneGeometry(8.5, 8.5), goldMat);
            frame.position.z = -0.1;
            group.add(photo, frame);
            const scatterPos = new THREE.Vector3().randomDirection().multiplyScalar(15);
            items.push({ mesh: group, treePos: new THREE.Vector3(0, 5, 0), scatterPos, type: 'PHOTO' });
            mainGroup.add(group);
        };

        // --- 4. 增强版 AI 加载 (异步) ---
        async function setupAI() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://fastly.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: `https://fastly.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm/hand_landmarker.task`, delegate: "GPU" },
                    runningMode: "VIDEO", numHands: 1
                });
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('webcam').srcObject = stream;
            } catch (e) { console.warn("AI Model or Camera delayed."); }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (handLandmarker && document.getElementById('webcam').readyState >= 2) {
                const results = handLandmarker.detectForVideo(document.getElementById('webcam'), performance.now());
                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    STATE.rotation.y = (lm[9].x - 0.5) * 2;
                    const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    if (d < 0.05) STATE.mode = 'FOCUS';
                    else if (lm[8].y > lm[0].y) STATE.mode = 'TREE';
                    else STATE.mode = 'SCATTER';
                }
            }
            mainGroup.rotation.y += 0.005 + (STATE.rotation.y * 0.05);
            items.forEach((item, i) => {
                let target = STATE.mode === 'TREE' ? item.treePos : item.scatterPos;
                item.mesh.position.lerp(target, 0.05);
            });
            composer.render();
        }

        setupAI();
        animate();
        // 关键：3D 初始化完成立刻关闭加载层，不让 AI 拖后腿
        setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 500);

        document.getElementById('imgInp').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => new THREE.TextureLoader().load(ev.target.result, t => window.addPhoto(t));
            reader.readAsDataURL(e.target.files[0]);
        };
    </script>
</body>
</html>
